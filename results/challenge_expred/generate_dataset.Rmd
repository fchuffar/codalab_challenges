---
title: "Gene expression in TCGA"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


TCGA Study Abbreviations:
https://gdc.cancer.gov/resources-tcga-users/tcga-code-tables/tcga-study-abbreviations


```{r, echo=FALSE, eval=TRUE}
library(epimedtools)
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide")
# genes
genes = readRDS("~/projects/genes/bed_grch38_epimeddb.rds")
dim(genes)
```

```{r}
os_keys = c("os", "efs")
os_keys = c("os")

tcga_projects = c(
  "TCGA-LUAD",
  "TCGA-LUSC",
  "TCGA-BRCA",
  "TCGA-LIHC",
  "TCGA-COAD",
  "TCGA-HNSC",
  "TCGA-DLBC",
  "TCGA-MESO",
  "TCGA-PRAD",
  "TCGA-SARC",
  "TCGA-TGCT",
  "TCGA-BLCA", #
  # "TCGA-CESC", # no sex defined
  "TCGA-GBM", #
  "TCGA-KIRC", #
  "TCGA-KIRP", #
  "TCGA-LGG", #
  "TCGA-SKCM", #
  "TCGA-THCA", #
  # "TCGA-LAML", # # blood
  "TCGA-UCEC", #
  "TCGA-ACC",
  "TCGA-CHOL",
  "TCGA-ESCA",
  "TCGA-KICH",
  "TCGA-PAAD",
  "TCGA-PCPG",
  "TCGA-READ",
  "TCGA-STAD",
  "TCGA-THYM",
  "TCGA-UCS",
  "TCGA-UVM",
  "TCGA-OV"
)
if (!exists("mreadRDS")) {
  mreadRDS = memoise::memoise(function(...) {
    readRDS(...)
  })
}
```

# TCGA projects

```{r}
tcga_stat = lapply(tcga_projects, function(tcga_project) {
  # tcga_project = "TCGA-LUAD"
  # print(tcga_project)
  study_trscr_filename = paste0("~/projects/tcga_studies/study_", tcga_project, "_trscr.rds")
  s = mreadRDS(study_trscr_filename)
  # print(dim(s$data))
  idx_normal = rownames(s$exp_grp)[s$exp_grp$tissue_status=="normal"]
  idx_tumoral = rownames(s$exp_grp)[s$exp_grp$tissue_status=="tumoral"]
  if (!"annotations_1_category" %in% colnames(s$exp_grp)) {
    s$exp_grp$annotations_1_category = NA
  } else {
    if (length(unique(s$exp_grp$annotations_1_category))==1) {
      s$exp_grp$annotations_1_category = NA    
    }    
  }
  idx_normal2 = rownames(s$exp_grp)[s$exp_grp$tissue_status=="normal"   & is.na(s$exp_grp$annotations_1_category)]
  idx_tumoral2 = rownames(s$exp_grp)[s$exp_grp$tissue_status=="tumoral" & is.na(s$exp_grp$annotations_1_category)]    
  ret = list(proj=tcga_project, nb_tumor=length(idx_tumoral), nb_ctrl=length(idx_normal), nb_tumor2=length(idx_tumoral2), nb_ctrl2=length(idx_normal2))
  return(ret)
})
tcga_stat = do.call(rbind, tcga_stat)
tcga_stat
```














# Factors

```{r}
url = paste0("http://epimed.univ-grenoble-alpes.fr/database/expgroup/","GSE30219")
df2 = read.csv2(url, header=TRUE, sep=";", stringsAsFactors=FALSE, dec=".", na.strings="", row.names=1)
colnames_exp_grp = colnames(df2)


colnames_exp_grp = lapply(tcga_projects, function(tcga_project) {
  study_trscr_filename = paste0("~/projects/tcga_studies/study_", tcga_project, "_trscr.rds")
  s = mreadRDS(study_trscr_filename)
  idx_sample = rownames(s$exp_grp)[is.na(s$exp_grp$annotations_1_category)]
  colnames(s$exp_grp)
})
colnames_exp_grp = do.call(epimedtools::intersect_rec, colnames_exp_grp)
```

# Gene expression

```{r}
gs = c(
 "ATAD2", "SYCP3",
 "BRDT", "BRD4", "NUTM1",
 "MAGEB6", "TUBA3C",
 "H19", "IGF2", "NNAT", "BLCAP",
 "SMYD3", "MAP3K2", "KDR",
 "TP53", "KRAS", "BRAF",
 "FASTKD1", "ND2", "ND3", "ND4" 
)

d = lapply(tcga_projects, function(tcga_project) {
  # tcga_project = "TCGA-LAML"
  # tcga_project = "TCGA-LUAD"
  # print(tcga_project)
  study_trscr_filename = paste0("~/projects/tcga_studies/study_", tcga_project, "_trscr.rds")
  s = mreadRDS(study_trscr_filename)
  idx_sample = rownames(s$exp_grp)[is.na(s$exp_grp$annotations_1_category)]
  res = cbind(
    data.frame(status=s$exp_grp[idx_sample,]$tissue_status, proj=tcga_project),
    t(s$data[gs,idx_sample]),
    s$exp_grp[idx_sample,colnames_exp_grp]
  )  
  return(res)
})
d = do.call(rbind, d)
d$proj = as.factor(d$proj)

head(d)
dim(d)



table(d$topology_group)
table(d$sample_source)



d = d[d$sample_source %in% c("Solid Tissue Normal", "Primary Tumor"),]
dim(d)

tmp_tab = table(d$topology_group)
d = d[d$topology_group %in% names(tmp_tab)[tmp_tab >=8],]
dim(d)

m = step(lm(paste0(gs[1], " ~ age_min + sex + tissue_group_level1 + tissue_status + main_gse_number+sample_source+sex+ethnic_group+topology_group+tissue_group_level1"), d))









table(d$sex                , d$proj, useNA="ifany")
d[d$proj %in% c("TCGA-OV", "TCGA-UCS", "TCGA-UCEC"),]$sex = "F"
d = d[!is.na(d$sex),]
table(d$sex                , d$proj, useNA="ifany")

table(is.na(d$age_min)                , d$proj, useNA="ifany")
table(is.na(d$age_min)                , d$tissue_status, useNA="ifany")
d = d[!is.na(d$age_min),]


sort(table(d$tissue_group_level1, useNA="ifany"))
tmp_tab = table(d$tissue_group_level1)
d = d[d$tissue_group_level1 %in% names(tmp_tab)[tmp_tab >=8],]
sort(table(d$tissue_group_level1, useNA="ifany"))

table(d$tissue_status,    d$tissue_group_level1  , useNA="ifany")
tmp_tab = sort(table(d[d$tissue_status %in% "normal",]$tissue_group_level1))
names(tmp_tab)[tmp_tab >=10]
d = d[d$tissue_status %in% "tumoral" | d$tissue_status %in% "normal" & d$tissue_group_level1 %in% names(tmp_tab)[tmp_tab >=10],]
table(d$tissue_status,    d$tissue_group_level1  , useNA="ifany")

table(d$main_gse_number    , useNA="ifany")


table(d$topology_group, d$tissue_group_level1)


# sort(apply(is.na(d[,colnames_exp_grp]), 2, sum))
# barplot(apply(is.na(d[,colnames_exp_grp]), 2, sum), las=2)



#m = step(lm(paste0(gs[1], " ~ age_min + sex + tissue_group_level1 + tissue_status + main_gse_number+sample_source+sex+ethnic_group+topology_group+tissue_group_level1"), d))

table(d$main_gse_number, d$tissue_group_level1)
table(d$topology_group, d$tissue_group_level1)

d$key = paste0(d$main_gse_number, "_", d$tissue_group_level1)
tmp_tab = sort(table(d$key))
d = d[d$key %in% names(tmp_tab)[tmp_tab >=16],]


table(d$tissue_status, d$tissue_group_level1)
table(d$tissue_status, d$main_gse_number)
table(d$tissue_group_level1, d$main_gse_number)

d =  d[,c("age_min", "sex", "tissue_status", "main_gse_number", "tissue_group_level1", "t", "n", "m", "tnm_stage", "tnm_grade", gs)]
colnames(d) = c("age", "sex", "tissue_status", "project", "tissue", "t", "n", "m", "tnm_stage", "tnm_grade", gs)
saveRDS(d, paste0("data_full.rds"))
d_full = readRDS("data_full.rds")
# stop("EFN")
```







# Obfuscation

```{r}
d = d_full

dim(d)
length(gs)

nrow(d) * length(gs)
nb_na = 20000

g = expand.grid(1:nrow(d), 1:length(gs))
set.seed(1) 
idx = sample(1:nrow(g), nb_na)

for (i in idx) {
  i_samples_na = g[i,1]
  i_g_na = gs[g[i,2]]
  d[i_samples_na, i_g_na] = NA
}

sum(is.na(d[,gs]))
saveRDS(d, paste0("data.rds"))

```







# gene expression

```{r}
layout(1)
sapply(gs, function(g) {
  print(g)
  boxplot(d[[g]]~d$project, las=2, main=g)
  # boxplot(d_full[[g]]~d$project, las=2, main=g)
  # beanplot::beanplot(d[[g]]~d$project, log="", las=2)
})
```


# Methods

## Variable selection


## Statistical method


QCM: Which function for linear model? lm? aov? rlm? glm? other?





# Results

## Statistical model

What are your main models? 

$$`s gs[1]` ~ sex$$

$$`s gs[2]` ~ sex$$

## Score on codalab

What is your score on codalab?





# Discussion

## Pros and cons each method

Discuss about the evolution of your score on codalab platform.

## Correlation between both genes?

Discuss about the correlation between these genes.






# Session Information

```{r, results="verbatim"}
sessionInfo()
```


